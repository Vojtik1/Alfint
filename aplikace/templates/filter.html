{% extends "base.html" %}
{% block title %}Filter Stocks{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <h1 class="title has-text-centered" style="color: #6a0dad;">Filter Stocks</h1>

        <!-- Vybrané filtry -->
        <div class="box">
            <h2 class="subtitle">Selected Filters</h2>
            <div id="selected-filters">
                {% for filter in filters %}
                    <div class="tag is-info is-light mb-1" data-field="{{ filter.field }}">
                        <strong>{{ filter.field|title }}</strong>: Min {{ filter.min }} - Max {{ filter.max }}
                        <button class="delete is-small" onclick="removeFilter('{{ filter.field }}')"></button>
                    </div>
                {% empty %}
                    <p>No filters applied yet.</p>
                {% endfor %}
            </div>
            <a href="?clear_filters=true" class="button is-danger is-small mt-2">Clear Filters</a>
        </div>

        <!-- Tlačítko pro přidání nového filtru -->
        <div class="box">
            <h2 class="subtitle">Add New Filter</h2>
            <button class="button is-link" onclick="openModal()">Add Filter</button>
        </div>



        <!-- Přidání akcií do portfolia -->
        {% if user.is_authenticated and user.portfolios.exists %}
        <div class="box">
            <form method="post" action="{% url 'add_all_filtered_to_portfolio' %}">
                {% csrf_token %}
                <div class="field">
                    <label class="label">Select Portfolio</label>
                    <div class="control">
                        <div class="select">
                            <select name="portfolio_id" required>
                                {% for portfolio in user.portfolios.all %}
                                    <option value="{{ portfolio.id }}">{{ portfolio.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <input type="hidden" name="filtered_tickers" value="{{ stocks|join:',' }}">
                <div class="control" style="text-align: center; margin-top: 20px;">
                    <button class="button is-link" type="submit">Add All Filtered Stocks to Portfolio</button>
                </div>
            </form>
        </div>
        {% endif %}

        <!-- Průměrná návratnost -->
        {% if average_return %}
        <div class="notification is-primary has-text-centered">
            <p>Average Return of Filtered Stocks: <strong>{{ average_return|floatformat:2 }}%</strong></p>
        </div>
        {% endif %}

        <!-- Výsledky filtrovaných akcií -->
        <div id="stocks" class="columns is-multiline">
            {% for stock in stocks %}
                <div class="column is-one-quarter">
                    <div class="box" style="border-top: 4px solid #6a0dad;">
                        <h2 class="subtitle" style="color: #6a0dad;">{{ stock.name }}</h2>
                        <p><strong>P/E Ratio:</strong> {{ stock.pe_ratio|floatformat:2|default:"N/A" }}</p>
                        <p><strong>ROE (%):</strong> {{ stock.roe|floatformat:2|default:"N/A" }}</p>
                        <p><strong>Debt to Equity:</strong> {{ stock.debt_to_equity|floatformat:2|default:"N/A" }}</p>
                        <p><strong>Market Cap:</strong> {{ stock.market_cap|floatformat:2|default:"N/A" }}</p>
                        <a href="/stock/{{ stock.ticker }}" class="button is-link is-light mt-3">View Details</a>
                    </div>
                </div>
            {% empty %}
                <p>No stocks match the selected filters.</p>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Modální okno pro přidání filtru -->
<div class="modal" id="filterModal">
    <div class="modal-background" onclick="closeModal()"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Add New Filter</p>
            <button class="delete" aria-label="close" onclick="closeModal()"></button>
        </header>
        <section class="modal-card-body">
            <div class="field">
                <label class="label">Select Ratio</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id="filter-field">
                            {% for ratio in ratios %}
                                <option value="{{ ratio.field }}">{{ ratio.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="field">
                <label class="label">Minimum Value</label>
                <div class="control">
                    <input class="input" type="number" step="0.01" id="filter-min" placeholder="Enter minimum value">
                </div>
            </div>
            <div class="field">
                <label class="label">Maximum Value</label>
                <div class="control">
                    <input class="input" type="number" step="0.01" id="filter-max" placeholder="Enter maximum value">
                </div>
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" onclick="addFilter()">Add Filter</button>
            <button class="button" onclick="closeModal()">Cancel</button>
        </footer>
    </div>
</div>

<!-- JavaScript -->
<script>
    // Otevření modálního okna
    function openModal() {
        document.getElementById('filterModal').classList.add('is-active');
    }

    // Zavření modálního okna
    function closeModal() {
        document.getElementById('filterModal').classList.remove('is-active');
    }

    // Přidání nového filtru pomocí AJAX
    function addFilter() {
        const field = document.getElementById('filter-field').value;
        const min = document.getElementById('filter-min').value;
        const max = document.getElementById('filter-max').value;

        fetch('', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams({ field, min, max })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }

    // Odstranění filtru
    function removeFilter(field) {
        fetch(`?remove_filter=${field}`, { method: 'GET' })
            .then(() => location.reload());
    }
</script>
{% endblock %}

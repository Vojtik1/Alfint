{% extends "base.html" %}
{% block title %}Filter Stocks{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <!-- Sekce pro Filtry -->
        <h1 class="title has-text-centered" style="color: #6a0dad;">Filter Stocks</h1>

        <!-- Vybrané filtry -->
        <div class="box">
            <h2 class="subtitle">Selected Filters</h2>
            <div id="selected-filters">
                {% for filter in filters %}
                    <!-- "Hotový" filtr -->
                    <div
                        class="box mb-3 filter-box"
                        style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;"
                        onclick="toggleEditMode('{{ filter.field }}')"
                    >
                        <span style="font-weight: bold;">{{ filter.field|title }}</span>
                       <span>
    {% if filter.operator == 'gte' %}
        Bigger Than
    {% else %}
        Smaller Than
    {% endif %}
    : {{ filter.value }}
</span>

                    </div>

                    <!-- Editační režim pro filtr -->
                    <div
                        class="box mb-3 filter-edit-mode"
                        id="edit-{{ filter.field }}"
                        style="display: none; align-items: center;"
                    >
                        <span style="font-weight: bold; margin-right: 10px;">{{ filter.field|title }}</span>

                        <!-- Dropdown pro operátor -->
                        <div class="select mr-3">
                            <select
                                style="border-radius: 5px; height: 35px;"
                                onchange="updateFilter('{{ filter.field }}', 'operator', this.value)"
                            >
                                <option value="gte" {% if filter.operator == 'gte' %}selected{% endif %}>Bigger Than</option>
                                <option value="lte" {% if filter.operator == 'lte' %}selected{% endif %}>Smaller Than</option>
                            </select>
                        </div>

                        <!-- Input pro hodnotu -->
                        <input
                            class="input mr-3"
                            type="number"
                            step="0.01"
                            value="{{ filter.value }}"
                            style="width: 100px; border-radius: 5px; height: 35px;"
                            onchange="updateFilter('{{ filter.field }}', 'value', this.value)"
                        />

                        <!-- Tlačítko Confirm -->
                        <button
                            class="button is-success is-small mr-2"
                            onclick="confirmFilters()"
                        >
                            Confirm
                        </button>

                        <!-- Smazání filtru -->
                        <button
                            class="delete ml-2"
                            onclick="removeFilter('{{ filter.field }}')"
                        ></button>
                    </div>
                {% empty %}
                    <p>No filters applied yet.</p>
                {% endfor %}
            </div>

            <a href="?clear_filters=true" class="button is-danger is-small mt-2">Clear Filters</a>

        </div>

        <!-- Tlačítko pro přidání nového filtru -->
        <div class="box">
            <h2 class="subtitle">Add New Filter</h2>
            <button class="button is-link" onclick="openModal()">Add Filter</button>
        </div>

        <!-- Výsledky filtrovaných akcií -->
        <h2 class="subtitle mt-5">Filtered Stocks</h2>
        <div id="stocks">
            {% for stock in stocks %}
                <div class="box mb-2">
                    <a href="/stock/{{ stock.ticker }}" style="text-decoration: none; color: inherit;">
                        <h3 class="subtitle">{{ stock.name }}</h3>
                        <p>P/E Ratio: {{ stock.pe_ratio|floatformat:2|default:"N/A" }}</p>
                        <p>Market Cap: {{ stock.market_cap|floatformat:2|default:"N/A" }}</p>
                    </a>
                </div>
            {% empty %}
                <p>No stocks match the selected filters.</p>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Modální okno pro přidání filtru -->
<div class="modal" id="filterModal">
    <div class="modal-background" onclick="closeModal()"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Add New Filter</p>
            <button class="delete" aria-label="close" onclick="closeModal()"></button>
        </header>
        <section class="modal-card-body">
            <div class="field">
                <label class="label">Select Ratio</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id="filter-field">
                            {% for ratio in ratios %}
                                <option value="{{ ratio.field }}">{{ ratio.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" onclick="addFilter()">Add Filter</button>
            <button class="button" onclick="closeModal()">Cancel</button>
        </footer>
    </div>
</div>

<script>
    function openModal() {
        document.getElementById('filterModal').classList.add('is-active');
    }

    function closeModal() {
        document.getElementById('filterModal').classList.remove('is-active');
    }

    function addFilter() {
        const field = document.getElementById('filter-field').value;
        fetch('', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': '{{ csrf_token }}' },
            body: new URLSearchParams({ field })
        }).then(() => location.reload());
    }

    function updateFilter(field, key, value) {
        fetch('/filter/update/', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
            body: JSON.stringify({ field, key, value })
        });
    }

    function confirmFilters() {
        location.reload();
    }

    function removeFilter(field) {
        fetch(`?remove_filter=${encodeURIComponent(field)}`, { method: 'GET' })
        .then(() => location.reload());
    }

    function toggleEditMode(field) {
        document.querySelectorAll('.filter-box').forEach(box => box.style.display = 'flex');
        document.querySelectorAll('.filter-edit-mode').forEach(edit => edit.style.display = 'none');

        document.getElementById(`edit-${field}`).style.display = 'flex';
        document.querySelector(`[data-field="${field}"]`).style.display = 'none';
    }
</script>
{% endblock %}

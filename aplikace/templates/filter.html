{% extends "base.html" %}
{% block title %}Filter Stocks{% endblock %}
{% block content %}

<section class="section">
    <div class="container">
        <h1 class="title has-text-centered" style="color: #6a0dad;">Filter Stocks</h1>
        <!-- Filtry, které už byly přidány -->
        <div id="selected-filters" class="box" style="border-top: 4px solid #6a0dad;">
            <h2 class="subtitle">Selected Filters</h2>
            <ul id="filter-list"></ul>
            <button id="clear-filters" class="button is-danger is-small">Clear Filters</button>
        </div>

        <!-- Formulář pro přidání nového filtru -->
        <div class="box" style="border-top: 4px solid #6a0dad;">
            <h2 class="subtitle">Add New Filter</h2>
            <div class="columns">
                <div class="column is-one-third">
                    <label class="label">Select Ratio</label>
                    <div class="control">
                        <div class="select">
                            <select id="filter-name">
                                <option value="" disabled selected>Select Ratio</option>
                                <option value="pe_ratio">P/E Ratio</option>
                                <option value="roe">ROE (%)</option>
                                <option value="roa">ROA (%)</option>
                                <option value="debt_to_equity">Debt to Equity</option>
                                <option value="current_ratio">Current Ratio</option>
                                <option value="quick_ratio">Quick Ratio</option>
                                <option value="price_to_sales_ratio">P/S Ratio</option>
                                <option value="price_to_book_ratio">P/B Ratio</option>
                                <option value="dividend_yield">Dividend Yield</option>
                                <option value="altman_z_score">Altman Z-Score</option>
                                <!-- Další indikátory -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="column is-one-third">
                    <label class="label">Minimum Value</label>
                    <div class="control">
                        <input id="filter-min" class="input" type="number" step="0.01" placeholder="Enter min value">
                    </div>
                </div>
                <div class="column is-one-third">
                    <label class="label">Maximum Value</label>
                    <div class="control">
                        <input id="filter-max" class="input" type="number" step="0.01" placeholder="Enter max value">
                    </div>
                </div>
            </div>
            <div class="control" style="text-align: center;">
                <button id="add-filter" class="button is-link">Add Filter</button>
            </div>
        </div>

        <!-- Tlačítko pro odeslání všech filtrů -->
        <form method="get" id="filter-form">
            <input type="hidden" id="filters-input" name="filters" value="">
            <div class="control" style="text-align: center;">
                <button class="button is-primary" type="submit">Apply Filters</button>
            </div>
        </form>

        <!-- Výsledky filtrů -->
        {% if average_return %}
            <div class="notification is-primary">
                <p>Average Return of Filtered Stocks: {{ average_return }}%</p>
            </div>
        {% endif %}

        <div class="columns is-multiline">
            {% for stock in stocks %}
                <div class="column is-one-quarter">
                    <div class="box" style="border-top: 4px solid #6a0dad;">
                        <h2 class="subtitle" style="color: #6a0dad;">{{ stock.name }}</h2>
                        <p><strong>Ticker:</strong> {{ stock.ticker }}</p>
                        <p><strong>P/E Ratio:</strong> {{ stock.pe_ratio|floatformat:2|default:"N/A" }}</p>
                        <p><strong>ROE (%):</strong> {{ stock.roe|floatformat:2|default:"N/A" }}</p>
                        <p><strong>Debt to Equity:</strong> {{ stock.debt_to_equity|floatformat:2|default:"N/A" }}</p>
                        <p><strong>Market Cap:</strong> {{ stock.market_cap|floatformat:2|default:"N/A" }}</p>
                        <a href="/stock/{{ stock.ticker }}" class="button is-link is-light mt-3">View Details</a>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- JavaScript pro dynamické filtry -->
<script>
    const filters = [];

    document.getElementById('add-filter').addEventListener('click', function () {
        const name = document.getElementById('filter-name').value;
        const min = document.getElementById('filter-min').value;
        const max = document.getElementById('filter-max').value;

        if (!name) {
            alert('Please select a ratio.');
            return;
        }

        // Přidání filtru do seznamu
        const filter = { name, min: min || null, max: max || null };
        filters.push(filter);

        // Aktualizace zobrazeného seznamu filtrů
        updateFilterList();
    });

    function updateFilterList() {
        const list = document.getElementById('filter-list');
        list.innerHTML = '';
        filters.forEach((filter, index) => {
            const item = document.createElement('li');
            item.textContent = `${filter.name} - Min: ${filter.min || 'N/A'}, Max: ${filter.max || 'N/A'}`;
            list.appendChild(item);
        });

        // Aktualizace skrytého inputu s JSON daty filtrů
        document.getElementById('filters-input').value = JSON.stringify(filters);
    }

    document.getElementById('clear-filters').addEventListener('click', function () {
        filters.length = 0;  // Vyčištění filtrů
        updateFilterList();
    });
</script>

{% endblock %}
